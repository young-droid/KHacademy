-- 한 줄 주석 ctrl + /
/* 범위 주석 ctrl + shift + / */

-- 예전 (11g 이전 버전) 오라클 구문 사용하기
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE; 

-- [관리자 계정]
CREATE USER member_cyj IDENTIFIED BY member1234;

-- [관리자 계정]
GRANT CONNECT, RESOURCE TO member_cyj;

-- [관리자 계정]
ALTER USER member_cyj DEFAULT TABLESPACE SYSTEM QUOTA
UNLIMITED ON SYSTEM; 

-- member_이니셜 계정 접속 방법 추가 

-- [멤버 계정]
-- 테이블명 : MEMBER
-- 컬럼명 : MEMBER_NO 숫자 기본키 '회원 번호(PK)'
--        MEMBER_ID VARCHAR2(20) NULL허용 X  '회원 아이디'
--        MEMBER_PW VARCHAR2(20) NULL허용 X '회원 비밀번호'
--        MEMBER_NM VARCHAR2(30) NULL허용 X '회원 이름'
--         MEMBER_GENDER CHAR(1) M 또는 F만 입력 가능 '회원 성별(M/F)'
--        ENROLL_DATE DATE 기본값 현재날짜 '회원 가입일'
--        SECESSION_FL CHAR(1) 기본값 'N', Y 또는 N만 입력 가능 '탈퇴여부(Y/N)'

CREATE TABLE MEMBER (
	MEMBER_NO NUMBER PRIMARY KEY,
	MEMBER_ID VARCHAR2(20) NOT NULL,
	MEMBER_PW VARCHAR2(20) NOT NULL, 
	MEMBER_NM VARCHAR2(30) NOT NULL, 
	MEMBER_GENDER CHAR(1) CHECK(MEMBER_GENDER IN ('M', 'F')),
	ENROLL_DATE DATE DEFAULT SYSDATE,
	SECESSION_FL CHAR(1) DEFAULT 'N' CHECK(SECESSION_FL IN ('Y', 'N')) 
);

COMMENT ON COLUMN MEMBER.MEMBER_NO IS '회원 번호(PK)';
COMMENT ON COLUMN MEMBER.MEMBER_ID IS '회원 아이디';
COMMENT ON COLUMN MEMBER.MEMBER_PW IS '회원 비밀번호';
COMMENT ON COLUMN MEMBER.MEMBER_NM IS '회원 이름';
COMMENT ON COLUMN MEMBER.MEMBER_GENDER IS '회원 성별(M/F)';
COMMENT ON COLUMN MEMBER.ENROLL_DATE IS '회원 가입일';
COMMENT ON COLUMN MEMBER.SECESSION_FL IS '탈퇴여부(Y/N)';

--

-- 게시판 테이블

CREATE TABLE BOARD(
    BOARD_NO NUMBER PRIMARY KEY,
    BOARD_TITLE VARCHAR2(200) NOT NULL,
    BOARD_CONTENT VARCHAR2(4000) NOT NULL,
    CREATE_DATE DATE DEFAULT SYSDATE,
    READ_COUNT NUMBER DEFAULT 0,
    MEMBER_NO NUMBER REFERENCES MEMBER  -- MEMBER 테이블 PK값 참조
);

COMMENT ON COLUMN BOARD.BOARD_NO        IS '게시글 번호';
COMMENT ON COLUMN BOARD.BOARD_TITLE     IS '게시글 제목';
COMMENT ON COLUMN BOARD.BOARD_CONTENT   IS '게시글 내용';
COMMENT ON COLUMN BOARD.CREATE_DATE     IS '게시글 작성일';
COMMENT ON COLUMN BOARD.READ_COUNT      IS '조회수';
COMMENT ON COLUMN BOARD.MEMBER_NO       IS '회원 번호(작성자)';

-- 댓글 테이블
CREATE TABLE REPLY(
    REPLY_NO NUMBER PRIMARY KEY,
    REPLY_CONTENT VARCHAR2(500) NOT NULL,
    CREATE_DATE DATE DEFAULT SYSDATE,
    MEMBER_NO NUMBER REFERENCES MEMBER, -- MEMBER 테이블 PK 참조
    BOARD_NO NUMBER REFERENCES BOARD -- BOARD 테이블 PK 참조
);

COMMENT ON COLUMN REPLY.REPLY_NO         IS '댓글 번호(PK)';
COMMENT ON COLUMN REPLY.REPLY_CONTENT    IS '댓글 내용';
COMMENT ON COLUMN REPLY.CREATE_DATE      IS '댓글 작성일';
COMMENT ON COLUMN REPLY.MEMBER_NO        IS '회원 번호(작성자)';
COMMENT ON COLUMN REPLY.BOARD_NO         IS '게시글 번호(어떤 게시글의 댓글인지 확인)';

-- 각 테이블 PK 생성용 시퀀스 생성
CREATE SEQUENCE SEQ_MEMBER_NO; -- 1부터 1씩 증가, 반복 X
CREATE SEQUENCE SEQ_BOARD_NO;
CREATE SEQUENCE SEQ_REPLY_NO;

-------------------------------------------------------------------------------------------

SELECT * FROM MEMBER ;

-- 아이디 중복 검사
SELECT COUNT(*) FROM MEMBER 
WHERE MEMBER_NO = 1 	
AND SECESSION_FL = 'N'; -- 탈퇴 안한 계정 



-- 회원 가입
INSERT INTO MEMBER VALUES (SEQ_MEMBER_NO.NEXTVAL, ? , ? , ? , ? , DEFAULT, DEFAULT);

-- 로그인 
SELECT MEMBER_NO, MEMBER_ID, MEMBER_NM, MEMBER_GENDER, ENROLL_DATE 
						 FROM MEMBER WHERE MEMBER_ID = ?
						 AND MEMBER_PW = ? 
						 AND SECESSION_FL = 'N'

-- 전체 회원 조회
SELECT MEMBER_ID, MEMBER_NM, ENROLL_DATE						
						FROM MEMBER 
						WHERE SECESSION_FL = 'N'

-- updateMyInfo 회원 정보 수정	(이름, 성별)					
UPDATE MEMBER 
SET MEMBER_NM = ?, MEMBER_GENDER = ?
WHERE MEMBER_ID = ?;

-- updatePw 회원 비밀번호 수정
UPDATE MEMBER
SET MEMBER_PW = ? 
WHERE MEMBER_NO = ?
AND MEMBER_PW = ?

; ROLLBACK;

-- secession 회원 탈퇴
SELECT * FROM MEMBER;
UPDATE MEMBER 
SET SECESSION_FL='Y' 
WHERE MEMBER_NO = 41;
